<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnostics - Astral Turf</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      background: #0f172a;
      color: #e2e8f0;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: #60a5fa; margin-bottom: 20px; font-size: 2rem; }
    h2 { color: #818cf8; margin: 30px 0 15px 0; font-size: 1.5rem; border-bottom: 2px solid #334155; padding-bottom: 10px; }
    .section { background: #1e293b; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #334155; }
    .status { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.875rem; font-weight: bold; margin-left: 10px; }
    .status.ok { background: #10b981; color: white; }
    .status.error { background: #ef4444; color: white; }
    .status.warning { background: #f59e0b; color: white; }
    .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #334155; }
    .info-row:last-child { border-bottom: none; }
    .label { color: #94a3b8; }
    .value { color: #e2e8f0; font-weight: bold; }
    pre { background: #0f172a; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 0.875rem; margin: 10px 0; border: 1px solid #334155; }
    button { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; }
    button:hover { background: #2563eb; }
    button.danger { background: #ef4444; }
    button.danger:hover { background: #dc2626; }
    .log { margin: 5px 0; padding: 5px; border-left: 3px solid #334155; padding-left: 10px; }
    .log.error { border-color: #ef4444; color: #fca5a5; }
    .log.warning { border-color: #f59e0b; color: #fcd34d; }
    .log.success { border-color: #10b981; color: #6ee7b7; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Astral Turf Diagnostics</h1>
    
    <div class="section">
      <h2>Service Worker Status</h2>
      <div id="sw-status">Checking...</div>
    </div>
    
    <div class="section">
      <h2>Cache Status</h2>
      <div id="cache-status">Checking...</div>
    </div>
    
    <div class="section">
      <h2>Storage Status</h2>
      <div id="storage-status">Checking...</div>
    </div>
    
    <div class="section">
      <h2>React Context State</h2>
      <div id="context-status">Checking...</div>
    </div>
    
    <div class="section">
      <h2>Player Data</h2>
      <div id="player-data">Checking...</div>
    </div>
    
    <div class="section">
      <h2>Quick Actions</h2>
      <button onclick="clearEverything()">üóëÔ∏è Clear All Caches</button>
      <button onclick="testNavigation()">üîó Test Navigation</button>
      <button onclick="loadPlayerData()">üë• Load Player Data</button>
      <button onclick="window.location.href='/'" class="danger">üè† Go to Home</button>
    </div>
    
    <div class="section">
      <h2>Console Logs</h2>
      <div id="console-logs"></div>
    </div>
  </div>

  <script>
    // Override console to capture logs
    const originalConsole = { ...console };
    const logs = [];
    
    ['log', 'error', 'warn'].forEach(method => {
      console[method] = (...args) => {
        const type = method === 'error' ? 'error' : method === 'warn' ? 'warning' : 'success';
        logs.push({ type, message: args.join(' '), time: new Date().toLocaleTimeString() });
        updateConsoleLogs();
        originalConsole[method](...args);
      };
    });
    
    function updateConsoleLogs() {
      const container = document.getElementById('console-logs');
      container.innerHTML = logs.slice(-20).reverse().map(log => 
        `<div class="log ${log.type}">[${log.time}] ${log.message}</div>`
      ).join('');
    }
    
    async function checkServiceWorker() {
      const container = document.getElementById('sw-status');
      
      if (!('serviceWorker' in navigator)) {
        container.innerHTML = '<span class="status error">NOT SUPPORTED</span>';
        return;
      }
      
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        const active = registrations.find(r => r.active);
        
        if (!active) {
          container.innerHTML = '<span class="status warning">NO ACTIVE SW</span>';
          return;
        }
        
        const scriptURL = active.active?.scriptURL || 'Unknown';
        const state = active.active?.state || 'Unknown';
        
        container.innerHTML = `
          <div class="info-row"><span class="label">Status:</span><span class="value status ok">ACTIVE</span></div>
          <div class="info-row"><span class="label">Script:</span><span class="value">${scriptURL}</span></div>
          <div class="info-row"><span class="label">State:</span><span class="value">${state}</span></div>
          <div class="info-row"><span class="label">Registrations:</span><span class="value">${registrations.length}</span></div>
        `;
      } catch (error) {
        container.innerHTML = `<span class="status error">ERROR: ${error.message}</span>`;
      }
    }
    
    async function checkCaches() {
      const container = document.getElementById('cache-status');
      
      if (!('caches' in window)) {
        container.innerHTML = '<span class="status error">NOT SUPPORTED</span>';
        return;
      }
      
      try {
        const cacheNames = await caches.keys();
        const v3Caches = cacheNames.filter(name => name.includes('v3'));
        const oldCaches = cacheNames.filter(name => !name.includes('v3'));
        
        container.innerHTML = `
          <div class="info-row"><span class="label">Total Caches:</span><span class="value">${cacheNames.length}</span></div>
          <div class="info-row"><span class="label">v3 Caches:</span><span class="value status ${v3Caches.length > 0 ? 'ok' : 'warning'}">${v3Caches.length}</span></div>
          <div class="info-row"><span class="label">Old Caches:</span><span class="value status ${oldCaches.length > 0 ? 'warning' : 'ok'}">${oldCaches.length}</span></div>
          <pre>${JSON.stringify(cacheNames, null, 2)}</pre>
        `;
        
        if (oldCaches.length > 0) {
          console.warn('‚ö†Ô∏è Old caches detected:', oldCaches);
        }
      } catch (error) {
        container.innerHTML = `<span class="status error">ERROR: ${error.message}</span>`;
      }
    }
    
    function checkStorage() {
      const container = document.getElementById('storage-status');
      
      try {
        const localKeys = Object.keys(localStorage);
        const sessionKeys = Object.keys(sessionStorage);
        const astralKeys = localKeys.filter(k => k.toLowerCase().includes('astral'));
        
        const stateData = localStorage.getItem('appState');
        const hasState = !!stateData;
        const stateSize = stateData ? (stateData.length / 1024).toFixed(2) : 0;
        
        container.innerHTML = `
          <div class="info-row"><span class="label">localStorage Keys:</span><span class="value">${localKeys.length}</span></div>
          <div class="info-row"><span class="label">sessionStorage Keys:</span><span class="value">${sessionKeys.length}</span></div>
          <div class="info-row"><span class="label">Astral Keys:</span><span class="value">${astralKeys.length}</span></div>
          <div class="info-row"><span class="label">App State:</span><span class="value status ${hasState ? 'ok' : 'error'}">${hasState ? 'FOUND' : 'MISSING'}</span></div>
          <div class="info-row"><span class="label">State Size:</span><span class="value">${stateSize} KB</span></div>
          <details style="margin-top: 15px;">
            <summary style="cursor: pointer; color: #60a5fa;">View Astral Keys</summary>
            <pre>${JSON.stringify(astralKeys, null, 2)}</pre>
          </details>
        `;
      } catch (error) {
        container.innerHTML = `<span class="status error">ERROR: ${error.message}</span>`;
      }
    }
    
    function checkContextState() {
      const container = document.getElementById('context-status');
      
      try {
        const appState = localStorage.getItem('appState');
        
        if (!appState) {
          container.innerHTML = `
            <span class="status error">NO STATE</span>
            <p style="margin-top: 10px; color: #fca5a5;">App state not found in localStorage. This is why players aren't loading!</p>
          `;
          return;
        }
        
        const state = JSON.parse(appState);
        const playerCount = state.tactics?.players?.length || 0;
        const formations = Object.keys(state.tactics?.formations || {}).length;
        
        container.innerHTML = `
          <div class="info-row"><span class="label">State Version:</span><span class="value">${state.version || 'Unknown'}</span></div>
          <div class="info-row"><span class="label">Auth Status:</span><span class="value status ${state.auth?.isAuthenticated ? 'ok' : 'warning'}">${state.auth?.isAuthenticated ? 'LOGGED IN' : 'NOT LOGGED IN'}</span></div>
          <div class="info-row"><span class="label">User:</span><span class="value">${state.auth?.user?.email || 'None'}</span></div>
          <div class="info-row"><span class="label">Players:</span><span class="value status ${playerCount > 0 ? 'ok' : 'error'}">${playerCount}</span></div>
          <div class="info-row"><span class="label">Formations:</span><span class="value">${formations}</span></div>
        `;
      } catch (error) {
        container.innerHTML = `<span class="status error">PARSE ERROR: ${error.message}</span>`;
      }
    }
    
    function checkPlayerData() {
      const container = document.getElementById('player-data');
      
      try {
        const appState = localStorage.getItem('appState');
        if (!appState) {
          container.innerHTML = '<span class="status error">NO STATE</span>';
          return;
        }
        
        const state = JSON.parse(appState);
        const players = state.tactics?.players || [];
        
        if (players.length === 0) {
          container.innerHTML = `
            <span class="status error">NO PLAYERS</span>
            <p style="margin-top: 10px; color: #fca5a5;">This is the root cause! Players array is empty in localStorage.</p>
            <p style="margin-top: 5px; color: #fcd34d;">Solution: Clear localStorage and reload to get default players.</p>
          `;
          return;
        }
        
        const withPositions = players.filter(p => p.fieldPosition).length;
        const withoutPositions = players.length - withPositions;
        
        container.innerHTML = `
          <div class="info-row"><span class="label">Total Players:</span><span class="value status ok">${players.length}</span></div>
          <div class="info-row"><span class="label">With Field Position:</span><span class="value">${withPositions}</span></div>
          <div class="info-row"><span class="label">Without Position:</span><span class="value">${withoutPositions}</span></div>
          <details style="margin-top: 15px;">
            <summary style="cursor: pointer; color: #60a5fa;">View Player Details</summary>
            <pre>${JSON.stringify(players.map(p => ({
              id: p.id,
              name: p.name,
              number: p.jerseyNumber,
              role: p.roleId,
              position: p.fieldPosition
            })), null, 2)}</pre>
          </details>
        `;
      } catch (error) {
        container.innerHTML = `<span class="status error">ERROR: ${error.message}</span>`;
      }
    }
    
    async function clearEverything() {
      if (!confirm('This will clear ALL data. Continue?')) return;
      
      console.log('üóëÔ∏è Starting nuclear clear...');
      
      // Unregister SWs
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const reg of registrations) {
        await reg.unregister();
        console.log('‚úÖ Unregistered SW');
      }
      
      // Delete caches
      const cacheNames = await caches.keys();
      for (const name of cacheNames) {
        await caches.delete(name);
        console.log('‚úÖ Deleted cache:', name);
      }
      
      // Clear storage
      localStorage.clear();
      sessionStorage.clear();
      console.log('‚úÖ Cleared storage');
      
      alert('All data cleared! Redirecting to home...');
      window.location.href = '/';
    }
    
    function testNavigation() {
      console.log('üß™ Testing navigation...');
      
      const testRoutes = [
        '/dashboard',
        '/tactics',
        '/challenge-hub',
        '/player-card',
        '/analytics'
      ];
      
      console.log('Test routes:', testRoutes);
      console.log('Current location:', window.location.href);
      console.log('Hash:', window.location.hash);
      
      const testUrl = testRoutes[0];
      console.log('Attempting to navigate to:', testUrl);
      window.location.hash = `#${testUrl}`;
      
      setTimeout(() => {
        console.log('Navigation complete. New hash:', window.location.hash);
      }, 1000);
    }
    
    function loadPlayerData() {
      console.log('üë• Attempting to load player data...');
      
      const appState = localStorage.getItem('appState');
      if (!appState) {
        console.error('‚ùå No app state found');
        alert('No app state found! You need to log in first.');
        return;
      }
      
      const state = JSON.parse(appState);
      const players = state.tactics?.players || [];
      
      console.log('Players loaded:', players.length);
      console.table(players.map(p => ({
        ID: p.id,
        Name: p.name,
        Number: p.jerseyNumber,
        Role: p.roleId,
        HasPosition: !!p.fieldPosition
      })));
      
      alert(`Found ${players.length} players. Check console for details.`);
    }
    
    // Run all checks on load
    window.addEventListener('load', async () => {
      console.log('üöÄ Running diagnostics...');
      await checkServiceWorker();
      await checkCaches();
      checkStorage();
      checkContextState();
      checkPlayerData();
      console.log('‚úÖ Diagnostics complete');
    });
  </script>
</body>
</html>

